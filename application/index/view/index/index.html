{include file="header"}

<ul class="layui-nav layui-nav-tree" lay-filter="test" style="height: 100%;position:absolute;top: 0;padding-top: 60px" id="menu">
    <li class="layui-nav-item type-all" data-type="0"><a href="javascript:;">全部文件</a></li>
    <li class="layui-nav-item type-image" data-type="1"><a href="javascript:;">图片</a></li>
    <li class="layui-nav-item type-document" data-type="2"><a href="javascript:;">文档</a></li>
    <li class="layui-nav-item type-music" data-type="3"><a href="javascript:;">音乐</a></li>
    <li class="layui-nav-item type-video" data-type="4"><a href="javascript:;">视频</a></li>
    <li class="layui-nav-item type-other" data-type="5"><a href="javascript:;">其他</a></li>
    <li class="layui-nav-item sharetable"><a href="javascript:;">我的分享</a></li>
    <li class="layui-nav-item bintable"><a href="javascript:;">回收站</a></li>
</ul>
<div class="container">
    <div class="container-top">
        <button type="button" class="layui-btn   layui-btn-normal layui-btn-sm" id="upload">
        <i class="layui-icon">&#xe67c;</i>上传文件
        </button>
        <input type="file" id="uploadfile" hidden>

        <button class="layui-btn layui-btn-primary layui-btn-sm" id="newFolder"> <i class="layui-icon">&#xe7a0;</i>新建文件夹</button>
        <div class="layui-btn-group">
            <button class="layui-btn layui-btn-primary layui-btn-sm" id="download"><i class="layui-icon" >&#xe61e;</i>下载</button>
            <button class="layui-btn layui-btn-primary layui-btn-sm" id="share"><i class="layui-icon">&#xe64c;</i>分享</button>
            <button class="layui-btn layui-btn-primary layui-btn-sm" id="deleteAll"><i class="layui-icon">&#xe640;</i>删除</button>
            <button class="layui-btn layui-btn-primary layui-btn-sm" id="rename" >重命名</button>
            <button class="layui-btn layui-btn-primary layui-btn-sm" id="copy">复制到</button>
            <button class="layui-btn layui-btn-primary layui-btn-sm" id="remove">移动到</button>
        </div>
        <div class="search" >
        <div class="layui-input-inline"><input type="text" class=" layui-input " placeholder="搜索您的文件" ></div>
        <i class="layui-icon" style="float:right;color:#999;margin-right:10px">&#xe615;</i>
    </div>
        <button type="button" class="layui-btn   layui-btn-normal layui-btn-sm" id="clearall" hidden="true" style="float: right">
            <i class="layui-icon">&#xe640;</i>清空回收站
        </button>
    </div>
    <div class="filelist">
        <span class="layui-breadcrumb">
            <a href="{:url('index/index?path=0')}">全部文件</a>

            <a><cite>正文</cite></a>
       </span>

    </div>
    <div class="fileshow">
        <table class="layui-table"  id="file-table">
            <thead>
            <tr>
                <th style="width: 600px">文件名</th>
                <th style="width: 220px;" >大小</th>
                <th id="time">创建时间</th>
            </tr>
            </thead>
        </table>
    </div>
</div>
<script>
    $(function(){
        var layer
        layui.use('layer',function () {
            layer = layui.layer
        })
        //新建文件夹
        $('#newFolder').click(function(){
            if ($('.btn-folder').length>0){
                return
            }
            $('#file-table').prepend('<tr class="tr">\n' +
                '                <td ><i class="layui-icon fileicon" >&#xe622;</i>\n' +
                '                    <span>\n' +
                '                        <input type="text" name="filename" id="inputfilename" value="新建文件夹">\n' +
                '                        <span id="confirm" class="btn-folder"><i class="layui-icon">&#xe605;</i></span>\n' +
                '                        <span id="cancel" class="btn-folder"><i class="layui-icon">&#x1006;</i></span>\n' +
                '                    </span>\n' +
                '                </td>\n' +
                '                </td>\n' +
                '                <td></td>\n' +
                '                <td></td>\n' +
                '            </tr>')
        })
        $('#file-table').delegate('#cancel','click',function(){
            $(this).parent().parent().parent().remove()
        })
        $('#file-table').delegate('#confirm','click',function(){
            var foldername = $('#inputfilename').val()
            $.post('createFolder',{foldername:foldername,parentid:GetParam('path')},function (data) {
                if (data.code==0){
                    layer.msg('文件名已存在！')
                    return
                }
                getData(GetParam('path'))
            },'json');
        })

        //获取url参数
        function GetParam (name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i")
            var r = window.location.search.substr(1).match(reg)
            if (r != null){
                return decodeURI(r[2])
            }else{
                return null
            }
        }
        //获取文件列表
        function getData(id) {
            $('.tr').remove()
            $('#time').text('创建时间')
            $('.layui-nav').find('li[data-type=0]').addClass('menu-active').siblings().removeClass('menu-active')
            history.replaceState({path:GetParam('path')},null,location.pathname + '?path='+id)
            $.get('showfolder',{path:id},function (data) {
               data.forEach(function (value, index) {
                   $('#file-table').prepend(' <tr class="tr folder" id='+value.folderid+'>\n' +
                       '                <td><div class="layui-unselect layui-form-checkbox" lay-skin="primary"><i class="layui-icon"></i></div><i class="layui-icon fileicon">&#xe622;</i>'+value.foldername+'</td>\n' +
                       '                <td></td>\n' +
                       '                <td>'+value.createtime+'</td>\n' +
                       '            </tr>')
               })
                $.get('showfile',{path:id},function (data) {
                    data.forEach(function (value, index) {
                        switch (value.filetype){
                            case 1:var icon = '<div class="icons icons-image"></div>';break;
                            case 2:var icon = '<div class="icons icons-documnet"></div>';break;
                            case 3:var icon = '<div class="icons icons-music"></div>';break;
                            case 4:var icon = '<div class="icons icons-video"></div>';break;
                            case 5:var icon = '<div class="icons icons-other"></div>';break;
                        }
                        switch (value.filesize<1000?1:(value.filesize<1000*1000?2:3)){
                            case 1:var size=value.filesize+'B';break;
                            case 2:
                                var num=(value.filesize/1000).toFixed(1);
                                var size=num+'K';break;
                            case 3:
                                var num=(value.filesize/1000000).toFixed(1);
                                var size=num+'M';break;
                            case 4:
                                var num=(value.filesize/1000000000).toFixed(1)
                                var size=num+'G';break;
                        }
                        $('#file-table').append(' <tr class="tr file" id='+value.fileid+'>\n' +
                            '                <td><div class="layui-unselect layui-form-checkbox" lay-skin="primary"><i class="layui-icon"></i></div>'+ icon +value.filename+'</td>\n' +
                            '                <td>'+size+'</td>\n' +
                            '                <td>'+value.createtime+'</td>\n' +
                            '            </tr>')
                    })
                },'json');
            },'json');
        }
        if(!GetParam('path')&&!GetParam('type')){
            getData(0)
        }
        if(GetParam('path')){
            getData(GetParam('path'))
        }
        if(GetParam('type')){
            getTypeData(GetParam('type'))
        }
        function getTypeData(type) {
            $('.tr').remove()
            $('#time').text('创建时间')
            $('.layui-nav').find('li[data-type='+type+']').addClass('menu-active').siblings().removeClass('menu-active')
            history.replaceState({type:GetParam('type')},null,location.pathname + '?type='+type)
                $.get('showtype',{type:type},function (data){
                    data.forEach(function (value,index) {
                        switch (value.filetype){
                            case 1:var icon = '<div class="icons icons-image"></div>';break;
                            case 2:var icon = '<div class="icons icons-documnet"></div>';break;
                            case 3:var icon = '<div class="icons icons-music"></div>';break;
                            case 4:var icon = '<div class="icons icons-video"></div>';break;
                            case 5:var icon = '<div class="icons icons-other"></div>';break;
                        }
                        switch (value.filesize<1000?1:(value.filesize<1000*1000?2:3)){
                            case 1:var size=value.filesize+'B';break;
                            case 2:
                                var num=(value.filesize/1000).toFixed(1);
                                var size=num+'K';break;
                            case 3:
                                var num=(value.filesize/1000000).toFixed(1);
                                var size=num+'M';break;
                            case 4:
                                var num=(value.filesize/1000000000).toFixed(1)
                                var size=num+'G';break;
                        }
                        $('#file-table').append(' <tr class="tr file" id='+value.fileid+'>\n' +
                            '                <td><div class="layui-unselect layui-form-checkbox" lay-skin="primary"><i class="layui-icon"></i></div>'+ icon +value.filename+'</td>\n' +
                            '                <td>'+size+'</td>\n' +
                            '                <td>'+value.createtime+'</td>\n' +
                            '            </tr>')
                    })
                },'json');
            }
        function getBin() {
            $('#time').text('删除时间')
            $('.layui-btn-group').hide();
            $('#search').hide()
            $('#upload').hide()
            $('#newFolder').hide()
            $('#clearall').show()
            $('.tr').remove()
            $.get('showBin',function (data){
                data.forEach(function (value,index) {
                    switch (value.filetype){
                        case 0:var icon='<i class="layui-icon fileicon">&#xe622;</i>';break;
                        case 1:var icon = '<div class="icons icons-image"></div>';break;
                        case 2:var icon = '<div class="icons icons-documnet"></div>';break;
                        case 3:var icon = '<div class="icons icons-music"></div>';break;
                        case 4:var icon = '<div class="icons icons-video"></div>';break;
                        case 5:var icon = '<div class="icons icons-other"></div>';break;
                    }
                    if(value.hasOwnProperty('filesize')){
                        switch (value.filesize<1000?1:(value.filesize<1000*1000?2:3)){
                            case 1:var size=value.filesize+'B';break;
                            case 2:
                                var num=(value.filesize/1000).toFixed(1);
                                var size=num+'K';break;
                            case 3:
                                var num=(value.filesize/1000000).toFixed(1);
                                var size=num+'M';break;
                            case 4:
                                var num=(value.filesize/1000000000).toFixed(1)
                                var size=num+'G';break;
                        }
                    }
                    else var size=''

                    $('#file-table').append(' <tr class="tr" id='+value.fileid+' data-type='+value.filetype+'>\n' +
                        '                <td><div class="layui-unselect layui-form-checkbox" lay-skin="primary"><i class="layui-icon"></i></div>'+ icon +value.filename+'</td>\n' +
                        '                <td>'+size+'</td>\n' +
                        '                <td>'+value.createtime+'</td>\n' +
                        '            </tr>')
                })
            },'json');
        }
        $('.type-all').click(function () {
            getData(0)
        })
        $('.type-document').click(function () {
            getTypeData(2)
        })
        $('.type-image').click(function () {
            getTypeData(1)
        })
        $('.type-music').click(function () {
            getTypeData(3)
        })
        $('.type-video').click(function () {
            getTypeData(4)
        })
        $('.type-other').click(function () {
            getTypeData(5)
        })
        $('.item_title').click(function () {

            getData(0)
        })
        $('.bintable').click(function () {
            getBin()
        })

        //监听历史回退
        window.addEventListener('popstate', function (e) {
            if(e.state.path){
                getData(e.state.path)
            }else{
                getTypeData(e.state.type)
            }
        });

        //点击上传按钮
        $('#upload').click(function () {
            $('#uploadfile').val('')
            $('#uploadfile').click()
        })

        //上传文件
        $('#uploadfile').change(function () {
            if(!this.value){
                return;
            }
            var formData = new FormData();
            formData.append("file",this.files[0]);
            formData.append("parentid", GetParam('path'));
            $.ajax({
                url : 'upload',
                type : 'POST',
                data : formData,
                processData : false,
                contentType : false,
                // xhr: function(){
                //     var xhr = $.ajaxSettings.xhr();
                    // if(xhr.upload) {
                    //     xhr.upload.addEventListener("progress" , onprogress, false);
                    //     return xhr;
                    // }
                // },
                success : function() {
                    getData(GetParam('path'))
                }
            });

        })

        //双击打开文件夹
        $('#file-table').delegate('tr.folder','dblclick',function(){
            getData(this.id)
            history.pushState({path:GetParam('path')},null,location.pathname + '?path='+GetParam('path'))
        })

        //单击选择或取消选择
        $('#file-table').delegate('.tr','click',function(){
            if($(this).find('.layui-form-checkbox').hasClass('layui-form-checked')){
                $(this).find('.layui-form-checkbox').removeClass('layui-form-checked')
            }else{
                $(this).find('.layui-form-checkbox').addClass('layui-form-checked')
            }

        })
        $('#deleteAll').click(function () {
            var arr = []
            $('.layui-form-checkbox').each(function () {
                if($(this).hasClass('layui-form-checked')){
                    if($(this).parent().parent().hasClass('folder')){
                        arr.push({
                            id: $(this).parent().parent().attr('id'),
                            type: 0
                        })
                    }else{
                        arr.push({
                            id: $(this).parent().parent().attr('id'),
                            type: 1
                        })
                    }
                }
            })
            $.post('Delete',{arr:arr},function (data) {
                getData(GetParam('path'))
            });
        })
        $('#rename').click(function () {        //重命名
            var arr = []
            if($('.layui-form-checked').parent().parent().hasClass('folder')){
                arr.push({
                    id:$('.layui-form-checked').parent().parent().attr('id'),
                    type:0
                })
            }
            else{
                arr.push({
                    id:$('.layui-form-checked').parent().parent().attr('id'),
                    name:'hejdjfs',
                    parentid:GetParam('path'),
                    type:1
                })
                }
            $.post('rename',{arr:arr},function (data) {
                getData(GetParam('path'))
            });
            }
        )

        function getSearch() {
            $('.tr').remove()
            $('#time').text('创建时间')
            $.get('search',{search:search },function (data){
                data.forEach(function (value,index) {
                    switch (value.filetype){
                        case 1:var icon = '<div class="icons icons-image"></div>';break;
                        case 2:var icon = '<div class="icons icons-documnet"></div>';break;
                        case 3:var icon = '<div class="icons icons-music"></div>';break;
                        case 4:var icon = '<div class="icons icons-video"></div>';break;
                        case 5:var icon = '<div class="icons icons-other"></div>';break;
                    }
                    switch (value.filesize<1000?1:(value.filesize<1000*1000?2:3)){
                        case 1:var size=value.filesize+'B';break;
                        case 2:
                            var num=(value.filesize/1000).toFixed(1);
                            var size=num+'K';break;
                        case 3:
                            var num=(value.filesize/1000000).toFixed(1);
                            var size=num+'M';break;
                        case 4:
                            var num=(value.filesize/1000000000).toFixed(1)
                            var size=num+'G';break;
                    }
                    $('#file-table').append(' <tr class="tr file" id='+value.fileid+'>\n' +
                        '                <td><div class="layui-unselect layui-form-checkbox" lay-skin="primary"><i class="layui-icon"></i></div>'+ icon +value.filename+'</td>\n' +
                        '                <td>'+size+'</td>\n' +
                        '                <td>'+value.createtime+'</td>\n' +
                        '            </tr>')
                })
            },'json');

        }
    })


</script>
</body>
</html>